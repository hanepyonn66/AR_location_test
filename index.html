<html>

<head>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

</head>

<body>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <body style="margin : 0px; overflow: hidden;">
    <a-scene embedded arjs>
      <a-box position="0 0 0" rotation="0 0 0" color="#4CC3D9" width="0.1" depth="0.1"></a-box>
      <a-box position="0 0 -1" rotation="0 0 0" color="#FF5733" width="0.1" depth="0.1"></a-box>
      <a-box position="0 0 -2" rotation="0 0 0" color="#77DD77" width="0.1" depth="0.1"></a-box>
      <a-box position="0 0 -3" rotation="0 0 0" color="#FFC300" width="0.1" depth="0.1"></a-box>
      <a-box position="0 0 -4" rotation="0 0 0" color="#9966CC" width="0.1" depth="0.1"></a-box>
      <a-entity id="rig" rotation=>
        <a-camera id="camera"></a-camera>
      </a-entity>

      <script>

        // OS識別用
        let os;
        // 初期化
        function init() {
          // 簡易的なOS判定
          os = detectOSSimply();
          if (os == "iphone") {
            // safari用。DeviceOrientation APIの使用をユーザに許可して貰う
            document.querySelector("#permit").addEventListener("click", permitDeviceOrientationForSafari);
            orientation();

          } else if (os == "android") {
            window.addEventListener(
              "deviceorientationabsolute",
              orientation,
              true
            );
          } else {
            alert("PC未対応サンプル");
          }
        }


        // ジャイロスコープと地磁気をセンサーから取得
        function orientation(event) {
          let absolute = event.absolute;
          let alpha = event.alpha;
          let beta = event.beta;
          let gamma = event.gamma;

          let degrees;
          if (os == "iphone") {
            // webkitCompasssHeading値を採用
            degrees = event.webkitCompassHeading;

          } else {
            // deviceorientationabsoluteイベントのalphaを補正
            degrees = compassHeading(alpha, beta, gamma);
          }
          var hogehogeValue = "0 " + degrees + " 0"; // 任意の値に置き換える
          alert(hogehogeValue);
          document.getElementById("rig").setAttribute("rotation", hogehogeValue);
        }

        // 端末の傾き補正（Android用）
        // https://www.w3.org/TR/orientation-event/
        function compassHeading(alpha, beta, gamma) {
          var degtorad = Math.PI / 180; // Degree-to-Radian conversion

          var _x = beta ? beta * degtorad : 0; // beta value
          var _y = gamma ? gamma * degtorad : 0; // gamma value
          var _z = alpha ? alpha * degtorad : 0; // alpha value

          var cX = Math.cos(_x);
          var cY = Math.cos(_y);
          var cZ = Math.cos(_z);
          var sX = Math.sin(_x);
          var sY = Math.sin(_y);
          var sZ = Math.sin(_z);

          // Calculate Vx and Vy components
          var Vx = -cZ * sY - sZ * sX * cY;
          var Vy = -sZ * sY + cZ * sX * cY;

          // Calculate compass heading
          var compassHeading = Math.atan(Vx / Vy);

          // Convert compass heading to use whole unit circle
          if (Vy < 0) {
            compassHeading += Math.PI;
          } else if (Vx < 0) {
            compassHeading += 2 * Math.PI;
          }

          return compassHeading * (180 / Math.PI); // Compass Heading (in degrees)
        }

        // 簡易OS判定
        function detectOSSimply() {
          let ret;
          if (
            navigator.userAgent.indexOf("iPhone") > 0 ||
            navigator.userAgent.indexOf("iPad") > 0 ||
            navigator.userAgent.indexOf("iPod") > 0
          ) {
            // iPad OS13のsafariはデフォルト「Macintosh」なので別途要対応
            ret = "iphone";
          } else if (navigator.userAgent.indexOf("Android") > 0) {
            ret = "android";
          } else {
            ret = "pc";
          }

          return ret;
        }

        // iPhone + Safariの場合はDeviceOrientation APIの使用許可をユーザに求める
        function permitDeviceOrientationForSafari() {
          DeviceOrientationEvent.requestPermission()
            .then(response => {
              if (response === "granted") {
                window.addEventListener(
                  "deviceorientation",
                  detectDirection
                );
              }
            })
            .catch(console.error);
        }
      </script>

    </a-scene>
  </body>

</html>